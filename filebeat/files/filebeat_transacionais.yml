apiVersion: v1
data:
  filebeat.yml: |

    setup:
        ilm.enabled: false
        template.enabled: false
        dashboards.enabled: false
    filebeat.autodiscover:
      providers:
        - type: kubernetes
          include_annotations: ["co.elastic.logs/enabled"]
          node: ${NODE_NAME}
          hints.enabled: true
          hints.default_config:
            enabled: false
            type: container
            paths:
              - /var/log/containers/*${data.kubernetes.container.id}.log
          templates:
            - condition:
                equals:
                  kubernetes.namespace: "ingress-nginx"
              config:
                - module: nginx
                  access:
                    enabled: false
                  error:
                    enabled: false
                  ingress_controller:
                    enabled: true
                    input:
                      type: container
                      paths:
                        - /var/log/containers/*${data.kubernetes.container.id}.log
            - condition:
                equals:
                  kubernetes.namespace: "sapo-emprego"
              config:
                - module: nginx
                  access:
                    enabled: true
                    input:
                      type: container
                      pipeline: filebeat-7.16.1-sapoemprego-access-pipeline
                      paths:
                        - /var/log/containers/*${data.kubernetes.container.id}.log
                  error:
                    enabled: false
                  ingress_controller:
                    enabled: false
                    input:
                      type: container
                      paths:
                        - /var/log/containers/*${data.kubernetes.container.id}.log
    processors:
      - drop_event:
          when:
            equals.kubernetes.namespace: "sapo-emprego-sandbox"
    output.elasticsearch:
      host: '${NODE_NAME}'
      hosts: '${ELASTICSEARCH_HOSTS:elasticsearch-master:9200}'
      username: "${FILEBEAT_USERNAME:filebeat_writer}"
      password: "${FILEBEAT_PASSWORD:changeme}"
      indices:
        - index: "filebeat-k8s-%{[kubernetes.namespace]:unknown}-%{[kubernetes.container.name]:unknown}"
          when:
            not.equals.kubernetes.namespace: "ingress-nginx"

        - index: "filebeat-k8s-%{[kubernetes.namespace]}"
          when:
            equals.kubernetes.namespace: "ingress-nginx"
